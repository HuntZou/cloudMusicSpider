<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Jhinwins</title>
    <!-- 网站小图标 -->
    <link rel="shortcut icon" href="../../../pic/ico.jpg" type="image/x-icon" />
    
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://apps.bdimg.com/libs/jqueryui/1.10.4/css/jquery-ui.min.css">
    <script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="http://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="../../../js/jhinwins.js"></script>

    <style type="text/css">

        @media screen and (max-aspect-ratio: 1/1) {
            body {
                background-image: url("../../../pic/bg_phone_3.jpg");
            }
        }

        @media screen and (min-aspect-ratio: 1/1) {
            body {
                background-image: url("../../../pic/bg_pc.jpg");
            }
        }

        body {
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-size: cover;
        }

        /*
        *背景透明
        */
        .bglucency {
            background-color: rgba(0, 0, 0, 0);
        }

        .searchBox {
            margin-top: 20%;
        }

        .commentBox {
            margin-top: 15%;
        }

        .playControlerElement {
            margin-left: 5%;
            margin-right: 7%;
        }

        .pointHandr:hover {
            cursor: pointer;
        }

        input {
            outline: none;
        }

        /*
        *音量控制滑块
        */
        .volumeControlerSlider {
            position: absolute;
            top: 25px;
            left: 30px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-md-4 searchBox">

            <form role="form">
                <div class="form-group">
                    <input id="searchInputBox" type="text" class="form-control" placeholder="歌曲名">
                </div>
            </form>

            <ul id="forecastBox" class="list-group bglucency">
            </ul>
            <div id="playControler">
                <div class="col-md-3 col-xs-3 col-sm-3">
                    <span class="glyphicon glyphicon-music musicLogo">&nbsp红豆</span>
                </div>
                <div class="col-md-9 col-xs-9 col-sm-9">
                    <span class="glyphicon glyphicon-pause playControlerElement pointHandr"></span>
                    <span class="glyphicon glyphicon-forward playControlerElement pointHandr"></span>
                    <span class="glyphicon glyphicon-stop playControlerElement pointHandr"></span>
                    <span class="glyphicon glyphicon-volume-down playControlerElement pointHandr"
                          onclick=toggleVolSlider()></span>
                </div>
            </div>

        </div>
        <div class="col-md-1"></div>
        <div class="col-md-7 commentBox">
            <table class="table">
                <tbody id="commentsList">
                </tbody>
            </table>
            <div id="turnPageBox">
                <button type="button" class="btn btn-default btn-sm bglucency" onclick=commentsTurnPage("pre")>
                    <span class="glyphicon glyphicon-circle-arrow-left"></span>向前翻
                </button>
                <button type="button" class="btn btn-default btn-sm bglucency" onclick=commentsTurnPage("next")>
                    向后翻<span class="glyphicon glyphicon-circle-arrow-right"></span>
                </button>
                <button type="button" class="btn btn-default btn-sm pull-right bglucency" onclick=toCommentsPage()>
                    <span class="glyphicon glyphicon glyphicon-search"></span>搜索
                </button>
            </div>
        </div>
    </div>
</div>

<!--音量控制滑块-->
<div id="volumeControlerSlider" class="volumeControlerSlider"></div>

<script type="text/javascript" src="../../../js/core.js"></script>
<script type="text/javascript">
    //----------------------------------------------------------field-----------------------------------------------------
    //当前页面选择的歌曲id
    var pageMusicId = 299757;
    //评论翻页
    var commentPage = 1;
    //一页显示评论条数
    var onePageCommentsCount = 9;
    //----------------------------------------------------------field-----------------------------------------------------


    $(function () {
        //隐藏翻页按钮
        $("#turnPageBox").hide();

        //搜索歌曲
        $('#searchInputBox').bind('input propertychange', function () {
            var data = getCloudMusicData("{\"s\":\"" + $('#searchInputBox').val() + "\",\"limit\":\"8\",\"csrf_token\":\"\"}");
            $.ajax({
                type: "POST",
                url: "searchMusic",
                dataType: "json",
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data: "params=" + data.encText + "&encSecKey=" + data.encSecKey,
                success: function (resp) {
                    $("#forecastBox").empty();
                    for (var i = 0; i < resp.result.songs.length; i++) {
                        //遍历每首歌的作者
                        var artists_str = "-";
                        for (var j = 0; j < resp.result.songs[i].artists.length; j++) {
                            artists_str += resp.result.songs[i].artists[j].name
                        }
                        $("#forecastBox").append("<li class=\"list-group-item  bglucency pointHandr\" onclick=selectMusic(" + resp.result.songs[i].id + ")>" + resp.result.songs[i].name + "" + artists_str + "</li>");
                    }
                }
            });

        });

        //音量控制滑块
        $("#volumeControlerSlider").hide();
        $("#volumeControlerSlider").slider({
            orientation: "vertical",
            range: "min",
            min: 0,
            max: 100,
            value: 35,
            slide: function (event, ui) {
                console.log("当前音量：" + ui.value)
            }
        });
    })

    //跳转到评论页
    function toCommentsPage() {
        window.open("comments.html?musicID=" + pageMusicId)
    }

    //点击音量开关显示音量调节
    function toggleVolSlider() {
        $("#volumeControlerSlider").toggle();
    }

    //选择歌曲
    function selectMusic(musicId) {
        //将评论页码重置为0
        commentPage = 0;
        //设置歌曲
        pageMusicId = musicId;
        //获取歌曲评论
        getComments(musicId, commentPage, "", "");
    }

    //根据用户名和内容获取评论
    function getComments(musicId, index, userName, content) {
        var showComments;
        var offset = 0;
        if (index > 0) {
            offset = (index - 1) * 20;
            showComments = function (resp) {
                if (resp.comments.length == onePageCommentsCount) {
                    $("#turnPageBox").show();
                }
                for (var i = 0; i < resp.comments.length; i++) {
                    $("#commentsList").append("<tr><td width='30%'>" + resp.comments[i].user.nickname + "</td><td>" + resp.comments[i].content + "</td></tr>");
                }
            }
        } else {
            showComments = function (resp) {
                //如果热评数量大于一页最多显示的数量则只显示少量的热评
                var showHotComments = onePageCommentsCount > resp.hotComments.length ? resp.hotComments.length : onePageCommentsCount;
                for (var i = 0; i < showHotComments; i++) {
                    $("#commentsList").append("<tr><td width='30%'>" + resp.hotComments[i].user.nickname + "</td><td>" + resp.hotComments[i].content + "</td></tr>");
                }
                //如果热评数量少于最多显示的数量则将新鲜的评论补上凑齐标准显示数量
                if ((onePageCommentsCount - showHotComments) > 0) {
                    var addCount = onePageCommentsCount - showHotComments;
                    //如果新鲜评论数量小于要补上的数量则显示所有评论
                    addCount = addCount > resp.comments.length ? resp.comments.length : addCount;
                    for (var i = 0; i < addCount; i++) {
                        $("#commentsList").append("<tr><td width='30%'>" + resp.comments[i].user.nickname + "</td><td>" + resp.comments[i].content + "</td></tr>");
                    }
                    if (addCount > resp.comments.length) {
                        $("#turnPageBox").show();
                    }
                } else {
                    $("#turnPageBox").show();
                }

            }
        }
        var data = getCloudMusicData("{\"rid\":\"R_SO_4_" + musicId + "\",\"offset\":\"" + offset + "\",\"total\":\"false\",\"limit\":\"" + onePageCommentsCount + "\",\"csrf_token\":\"\"}");
        $.ajax({
            type: "POST",
            url: "getComments",
            dataType: "json",
            data: "params=" + data.encText + "&encSecKey=" + data.encSecKey + "&musicId=" + musicId + "&userName=" + userName + "&content=" + content,
            success: function (resp) {

                $("#commentsList").empty();
                showComments(resp);
            }
        });
    }
    function commentsTurnPage(action) {
        if ("next" == action) {
            ++commentPage;
        } else if (commentPage > 0) {
            --commentPage
        } else {
            return;
        }
        if (pageMusicId != null)
            getComments(pageMusicId, commentPage, "", "");
    }
</script>
</body>
</html>