<!DOCTYPE html>
<html>
<head>
    <!-- meta使用viewport以确保页面可自由缩放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Jhinwins</title>
    <!-- 网站小图标 -->
    <link rel="shortcut icon" href="pic/ico.jpg" type="image/x-icon"/>

    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://apps.bdimg.com/libs/jqueryui/1.10.4/css/jquery-ui.min.css">
    <script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="http://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="js/jhinwins.js"></script>
    <!-- 引入 jQuery Mobile 库,监听触屏事件 -->
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <style type="text/css">

        @media screen and (max-aspect-ratio: 1/1) {
            body {
                background-image: url("pic/bg_phone_4.jpg");
            }
        }

        @media screen and (min-aspect-ratio: 1/1) {
            body {
                background-image: url("pic/bg_pc.jpg");
            }
        }

        /*
        * 去除jquerymobile底部的loading字样
        */
        .ui-loader-default {
            display: none
        }

        .ui-mobile-viewport {
            border: none;
        }

        .ui-page {
            padding: 0;
            margin: 0;
            outline: 0
        }

        body {
            background-size: cover;
            background-repeat: no-repeat;
        }

        /*
        *背景透明
        */
        .bglucency {
            background-color: rgba(0, 0, 0, 0);
        }

        .searchBox {
            margin-top: 20%;
        }

        .commentBox {
            margin-top: 15%;
        }

        .playControlerElement {
            margin-left: 5%;
            margin-right: 7%;
        }

        .pointHandr:hover {
            cursor: pointer;
        }

        input {
            outline: none;
        }

        /*
        *音量控制滑块
        */
        .volumeControlerSlider {
            position: absolute;
            top: 25px;
            left: 30px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-md-4 searchBox">

            <form role="form">
                <div class="form-group">
                    <input id="searchInputBox" type="text" class="form-control" placeholder="歌曲名">
                </div>
            </form>

            <ul id="forecastBox" class="list-group bglucency">
            </ul>
            <div id="playControler">
                <div class="col-md-3 col-xs-3 col-sm-3">
                    <span class="glyphicon glyphicon-music musicLogo">&nbspLucky</span>
                </div>
                <div class="col-md-9 col-xs-9 col-sm-9">
                    <audio id="audioSource"
                           src="http://m10.music.126.net/20170728113712/f42d028d9eb3b76fdb686cf27d879b27/ymusic/ecad/bbc2/60e9/437cc994efc2efbaae2935556bcf941d.mp3">
                        当前浏览器不支持播放音频,请更换或升级浏览器
                    </audio>
                    <!--播放按钮-->
                    <span id="playOrPauseSongBtn" class="glyphicon glyphicon-play playControlerElement pointHandr"
                          onclick=playOrPauseSong()></span>
                    <span class="glyphicon glyphicon-forward playControlerElement pointHandr"></span>
                    <span class="glyphicon glyphicon-stop playControlerElement pointHandr"></span>
                    <span class="glyphicon glyphicon-volume-down playControlerElement pointHandr"
                          onclick=toggleVolSlider()></span>
                </div>
            </div>

        </div>
        <div class="col-md-1"></div>
        <div class="col-md-7 commentBox">
            <table class="table">
                <tbody id="commentsList">
                </tbody>
            </table>
            <div id="turnPageBox">
            </div>
        </div>
    </div>
</div>

<!--音量控制滑块-->
<div id="volumeControlerSlider" class="volumeControlerSlider"></div>

<!--歌曲切换成功提示框-->
<div class="modal fade" id="changeSong" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">歌曲加载完成:p</div>
        </div>
    </div>
</div>

<script type="text/javascript" src="js/core.js"></script>
<script type="text/javascript">
    //----------------------------------------------------------field-----------------------------------------------------
    //当前页面选择的歌曲id
    var pageMusicId = 299757;
    //评论翻页
    var commentPage = 1;
    //一页显示评论条数
    var onePageCommentsCount = 9;
    //歌曲播放列表
    var musicList = new Array();
    //异步连接池
    var ajaxPool = new Array();
    //----------------------------------------------------------field-----------------------------------------------------


    $(function () {
        //隐藏翻页按钮
        $("#turnPageBox").hide();
        //添加翻页和搜索按钮
        $("#turnPageBox").append('<button type="button" class="btn btn-default btn-sm bglucency" onclick=commentsTurnPage("pre")>' +
            '<span class="glyphicon glyphicon-circle-arrow-left"></span>向前翻' +
            '</button>' +
            '<button type="button" class="btn btn-default btn-sm bglucency" onclick=commentsTurnPage("next")>' +
            '向后翻<span class="glyphicon glyphicon-circle-arrow-right"></span>' +
            '</button>' +
            '<button type="button" class="btn btn-default btn-sm pull-right bglucency" onclick=toCommentsPage()>' +
            '<span class="glyphicon glyphicon glyphicon-search"></span>搜索' +
            '</button>');

        //搜索歌曲
        $('#searchInputBox').bind('input propertychange', function () {
            if ($('#searchInputBox').val() == null || $('#searchInputBox').val().length == 0) {
                return;
            }
            var data = getCloudMusicData("{\"s\":\"" + $('#searchInputBox').val() + "\",\"limit\":\"8\",\"csrf_token\":\"\"}");
            clearAjaxPool();
            var searchMusicAjaxReq = $.ajax({
                type: "POST",
                url: "searchMusic",
                dataType: "json",
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data: "params=" + data.encText + "&encSecKey=" + data.encSecKey,
                success: function (resp) {
                    $("#forecastBox").empty();
                    for (var i = 0; i < resp.result.songs.length; i++) {
                        //遍历每首歌的作者
                        var artists_str = "-";
                        for (var j = 0; j < resp.result.songs[i].artists.length; j++) {
                            artists_str += resp.result.songs[i].artists[j].name
                        }
                        $("#forecastBox").append("<li class=\"list-group-item  bglucency pointHandr\" onclick=selectMusic(" + resp.result.songs[i].id + ")>" + resp.result.songs[i].name + "" + artists_str + "</li>");
                    }
                }
            });

            ajaxPool.push(searchMusicAjaxReq);

        });

        //音量控制滑块
        $("#volumeControlerSlider").hide();
        $("#volumeControlerSlider").slider({
            orientation: "vertical",
            range: "min",
            min: 0,
            max: 100,
            value: 35,
            slide: function (event, ui) {
                console.log("当前音量：" + ui.value)
            }
        });

        //滑动更换背景图片
        var currentBgCount = 7;
        $("body").on("swipeleft", function () {
            if (currentBgCount < 7)
                $("body").css("background-image", "url(pic/bg_phone_" + (++currentBgCount) + ".jpg)");
            console.log("currentBgCount:" + currentBgCount)
        });
        $("body").on("swiperight", function () {
            if (currentBgCount > 0)
                $("body").css("background-image", "url(pic/bg_phone_" + (--currentBgCount) + ".jpg)");
            console.log("currentBgCount:" + currentBgCount)
        });
    })

    //跳转到评论页
    function toCommentsPage() {
        window.open("comments.html?musicID=" + pageMusicId)
    }

    //点击音量开关显示音量调节
    function toggleVolSlider() {
        $("#volumeControlerSlider").toggle();
    }

    //选择预测歌曲
    function selectMusic(musicId) {
        //将评论页码重置为0
        commentPage = 0;
        //设置歌曲
        pageMusicId = musicId;
        //获取歌曲评论
        getComments(musicId, commentPage, "", "");

        //选择预测歌曲的同时将歌曲添加在播放列表中
        addMusic2List(musicId);
    }

    //根据用户名和内容获取评论
    function getComments(musicId, index, userName, content) {
        var showComments;
        var offset = 0;
        if (index > 0) {
            offset = (index - 1) * 20;
            showComments = function (resp) {
                if (resp.comments.length == onePageCommentsCount) {
                    $("#turnPageBox").show();
                }
                for (var i = 0; i < resp.comments.length; i++) {
                    $("#commentsList").append("<tr><td width='30%'>" + resp.comments[i].user.nickname + "</td><td>" + resp.comments[i].content + "</td></tr>");
                }
            }
        } else {
            showComments = function (resp) {
                //如果热评数量大于一页最多显示的数量则只显示少量的热评
                var showHotComments = onePageCommentsCount > resp.hotComments.length ? resp.hotComments.length : onePageCommentsCount;
                for (var i = 0; i < showHotComments; i++) {
                    $("#commentsList").append("<tr><td width='30%'>" + resp.hotComments[i].user.nickname + "</td><td>" + resp.hotComments[i].content + "</td></tr>");
                }
                //如果热评数量少于最多显示的数量则将新鲜的评论补上凑齐标准显示数量
                if ((onePageCommentsCount - showHotComments) > 0) {
                    var addCount = onePageCommentsCount - showHotComments;
                    //如果新鲜评论数量小于要补上的数量则显示所有评论
                    addCount = addCount > resp.comments.length ? resp.comments.length : addCount;
                    for (var i = 0; i < addCount; i++) {
                        $("#commentsList").append("<tr><td width='30%'>" + resp.comments[i].user.nickname + "</td><td>" + resp.comments[i].content + "</td></tr>");
                    }
                    if (addCount > resp.comments.length) {
                        $("#turnPageBox").show();
                    }
                } else {
                    $("#turnPageBox").show();
                }

            }
        }
        var data = getCloudMusicData("{\"rid\":\"R_SO_4_" + musicId + "\",\"offset\":\"" + offset + "\",\"total\":\"false\",\"limit\":\"" + onePageCommentsCount + "\",\"csrf_token\":\"\"}");
        clearAjaxPool();
        var getCommentAjaxReq = $.ajax({
            type: "POST",
            url: "getComments",
            dataType: "json",
            data: "params=" + data.encText + "&encSecKey=" + data.encSecKey + "&musicId=" + musicId + "&userName=" + userName + "&content=" + content,
            success: function (resp) {

                $("#commentsList").empty();
                showComments(resp);
            }
        });
        ajaxPool.push(getCommentAjaxReq);
    }
    function commentsTurnPage(action) {
        if ("next" == action) {
            ++commentPage;
        } else if (commentPage > 0) {
            --commentPage
        } else {
            return;
        }
        if (pageMusicId != null)
            getComments(pageMusicId, commentPage, "", "");
    }
    //选择播放歌曲
    function selectPlaySong(musicIndex) {
        if (musicIndex < musicList.length) {
            $("#audioSource").attr("src", musicList[musicIndex].url);
        }
    }
    //播放或者暂停歌曲
    function playOrPauseSong() {
        if ($("#audioSource")[0].paused) {
            $("#audioSource")[0].play();
            $("#playOrPauseSongBtn").removeClass("glyphicon-play");
            $("#playOrPauseSongBtn").addClass("glyphicon-pause");
        } else {
            $("#audioSource")[0].pause();
            $("#playOrPauseSongBtn").removeClass("glyphicon-pause");
            $("#playOrPauseSongBtn").addClass("glyphicon-play");
        }
    }
    //向播放列表中添加歌曲
    function addMusic2List(musicId) {
        var data = getCloudMusicData("{\"ids\":\"[" + musicId + "]\",\"br\":128000,\"csrf_token\":\"\"}")
        var addSongAjaxReq = $.ajax({
            type: "POST",
            url: "getSongInfo",
            dataType: "json",
            data: "params=" + data.encText + "&encSecKey=" + data.encSecKey + "&musicId=" + musicId,
            success: function (resp) {
                console.log("resp:" + resp.data[0].url)
                if (resp.code == 200) {
                    for (var i = 0; i < resp.data.length; i++) {
                        musicList.push(resp.data[i])
                    }

                    //添加歌曲到列表的同时将该歌曲放到播放器中,注：该方式仅适用于不显示播放列表的时候
                    selectPlaySong(musicList.length - 1);
                    console.log("歌曲已添加至播放器")
                    $("#changeSong").modal('show');
                    setTimeout(function () {
                        $("#changeSong").modal('hide');
                    }, 1000)
                }
            }
        });
        ajaxPool.push(addSongAjaxReq);
    }
    //清理ajax池
    function clearAjaxPool() {
        for (var i = 0; i < ajaxPool.length; i++) {
            ajaxPool[i].abort();
        }
        ajaxPool.length = 0;
    }
</script>
</body>
</html>